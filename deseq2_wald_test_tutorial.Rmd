---
title: "DESeq2 Differential Expression Analysis: Wald Test Tutorial"
subtitle: "Paired Design Analysis of Dexamethasone Treatment in Airway Smooth Muscle Cells"
author: "NGS Workshop 2026"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: show
    theme: cosmo
    highlight: tango
---

```{r setup, include=FALSE}
# Troubleshooting: If you encounter pandoc errors, try:
# 1. Restart R session: Session -> Restart R (in RStudio)
# 2. Reinstall rmarkdown: install.packages("rmarkdown")
# 3. Check pandoc: rmarkdown::pandoc_version()
# 4. If issues persist, restart RStudio completely

knitr::opts_chunk$set(
  warning = FALSE,
  message = FALSE,
  fig.width = 8,
  fig.height = 6,
  echo = TRUE,
  eval = TRUE,
  cache = FALSE
)
# source("Data_download.R")
```

# Introduction

## Dataset Overview

This tutorial demonstrates differential expression analysis using DESeq2's **Wald test** on a dataset of airway smooth muscle cells treated with dexamethasone. Dexamethasone is a glucocorticoid that has anti-inflammatory effects and is commonly used to treat asthma and other respiratory conditions.

**Biological Question:** Which genes are differentially expressed in airway smooth muscle cells following dexamethasone treatment?

## When to Use Wald Tests

The **Wald test** is appropriate for:

- **Pairwise comparisons** between two conditions (e.g., treated vs. untreated)
- Testing specific contrasts or coefficients in a linear model
- When you have a clear reference condition and want to test against it
- Simple experimental designs with one or a few comparisons

The Wald test provides:
- Log2 fold change estimates
- Standard errors for fold changes
- P-values for each gene
- Can be used with LFC shrinkage for improved estimates

## Experimental Design

This experiment uses a **paired design** with 4 cell lines, where each cell line has both untreated and treated samples. This design allows us to control for cell line-specific effects.

```{r design-table, echo=FALSE}
design_table <- data.frame(
  CellLine = rep(c("N080611", "N061011", "N61311", "N052611"), each = 2),
  Treatment = rep(c("untrt", "trt"), 4),
  Sample = paste0("SRR", c("1039508", "1039512", "1039516", "1039520", 
                           "1039509", "1039513", "1039517", "1039521"))
)
# Use tryCatch to handle potential pandoc/knitr errors
tryCatch({
  knitr::kable(design_table, caption = "Experimental Design: 4 cell lines × 2 treatments = 8 samples")
}, error = function(e) {
  # Fallback: print as a simple table
  cat("Experimental Design: 4 cell lines × 2 treatments = 8 samples\n\n")
  print(design_table)
})
```

**Key Design Features:**
- **Reference level:** "untrt" (untreated)
- **Treatment level:** "trt" (dexamethasone treated)
- **Blocking factor:** CellLine (accounts for cell line-specific variation)
- **Design formula:** `~ CellLine + Treatment`

---

# Load Libraries and Data

## Required Packages

```{r load-libraries}
library(DESeq2)
library(ggplot2)
library(pheatmap)
library(EnhancedVolcano)
library(dplyr)
library(tidyr)
library(gridExtra)
```

## Load Data Files

We'll load three data files:
1. **Metadata file:** Sample information and experimental design
2. **Counts file:** Gene expression counts (Ensembl IDs)
3. **Gene annotation file:** Gene symbols and names

```{r load-data}
# Load metadata
metadata <- read.table("airway_metadata_clean.txt", 
                       header = TRUE, 
                       sep = "\t",
                       stringsAsFactors = FALSE)

# Load counts
counts <- read.table("airway_counts_ensembl.txt",
                     header = TRUE,
                     sep = "\t",
                     stringsAsFactors = FALSE)

# Load gene annotations
gene_annot <- read.table("airway_gene_annotation.txt",
                         header = TRUE,
                         sep = "\t",
                         stringsAsFactors = FALSE)

# Check dimensions
cat("Metadata dimensions:", dim(metadata), "\n")
cat("Counts dimensions:", dim(counts), "\n")
cat("Gene annotation dimensions:", dim(gene_annot), "\n")
```

## Prepare Count Matrix

The counts file has EnsemblID and GeneSymbol columns that we need to remove to create a numeric matrix. We'll use EnsemblID as row names.

```{r prepare-counts}
# Extract sample columns (everything except EnsemblID and GeneSymbol)
sample_cols <- setdiff(colnames(counts), c("EnsemblID", "GeneSymbol"))
count_matrix <- as.matrix(counts[, sample_cols])

# Set row names to EnsemblID
rownames(count_matrix) <- counts$EnsemblID

# Ensure sample names match between counts and metadata
# Remove any file extensions or prefixes if needed
colnames(count_matrix) <- gsub("\\.(bam|sam)$", "", colnames(count_matrix))

# Verify sample names match
cat("Sample names in counts:", paste(colnames(count_matrix), collapse = ", "), "\n")
cat("Sample names in metadata:", paste(metadata$Sample, collapse = ", "), "\n")

# Check if all samples are present
all(metadata$Sample %in% colnames(count_matrix))
```

## Prepare Metadata

Ensure the metadata is properly formatted with factors in the correct order.

```{r prepare-metadata}
# Set Treatment as factor with "untrt" as reference
metadata$Treatment <- factor(metadata$Treatment, levels = c("untrt", "trt"))
metadata$CellLine <- factor(metadata$CellLine)

# Ensure sample order matches count matrix
metadata <- metadata[match(colnames(count_matrix), metadata$Sample), ]

# Verify
head(metadata)
```

---

# Quality Control

Before performing differential expression analysis, we should assess the quality of our data.

## Total Counts Per Sample

```{r qc-total-counts}
total_counts <- colSums(count_matrix)

qc_df <- data.frame(
  Sample = names(total_counts),
  TotalCounts = total_counts,
  Treatment = metadata$Treatment[match(names(total_counts), metadata$Sample)],
  CellLine = metadata$CellLine[match(names(total_counts), metadata$Sample)]
)

ggplot(qc_df, aes(x = Sample, y = TotalCounts, fill = Treatment)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Total Counts Per Sample",
       y = "Total Read Counts",
       x = "Sample") +
  scale_fill_manual(values = c("untrt" = "steelblue", "trt" = "coral"))
```

**Interpretation:** All samples have similar total read counts, indicating good sequencing depth and no major technical issues.

## Number of Genes Detected Per Sample

```{r qc-genes-detected}
genes_detected <- colSums(count_matrix > 0)

qc_df$GenesDetected <- genes_detected[match(qc_df$Sample, names(genes_detected))]

ggplot(qc_df, aes(x = Sample, y = GenesDetected, fill = Treatment)) +
  geom_bar(stat = "identity") +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Number of Genes Detected Per Sample",
       y = "Number of Genes (count > 0)",
       x = "Sample") +
  scale_fill_manual(values = c("untrt" = "steelblue", "trt" = "coral"))
```

**Interpretation:** The number of detected genes is consistent across samples, suggesting uniform sequencing quality.

---

# Create DESeqDataSet Object

## Design Formula

For this paired design, we use the formula:

```
~ CellLine + Treatment
```

**Why include CellLine?**
- **CellLine** is a blocking factor that accounts for cell line-specific variation
- This allows us to test the Treatment effect while controlling for differences between cell lines
- This is more powerful than a simple two-group comparison because it removes cell line-specific noise

**Note:** The order of terms matters. We put CellLine first because it's the blocking factor, and Treatment second because that's the effect we want to test.

## Create DESeqDataSet

```{r create-dds}
# Create DESeqDataSet
dds <- DESeqDataSetFromMatrix(
  countData = count_matrix,
  colData = metadata,
  design = ~ CellLine + Treatment
)

# Pre-filter low count genes
# Keep genes with at least 10 reads total across all samples
keep <- rowSums(counts(dds)) >= 10
dds <- dds[keep, ]

cat("Number of genes before filtering:", nrow(count_matrix), "\n")
cat("Number of genes after filtering:", nrow(dds), "\n")
```

**Note:** Pre-filtering low count genes improves performance and reduces multiple testing burden, as genes with very few counts cannot provide reliable differential expression results.

---

# Run DESeq2 Analysis

## Run DESeq()

The `DESeq()` function performs several steps:

1. **Estimation of size factors:** Normalizes for library size differences
2. **Estimation of dispersions:** Models gene-wise variability
3. **Negative binomial GLM fitting:** Fits generalized linear models
4. **Wald statistics:** Computes test statistics and p-values for each coefficient

```{r run-deseq}
dds <- DESeq(dds)
```

**Note:** This may take a few minutes depending on the number of genes and samples.

## Check Results Names

```{r results-names}
resultsNames(dds)
```

**Interpretation:**
- `Intercept`: Baseline expression level
- `CellLine_N061011_vs_N080611`: Comparison between cell lines (not of interest here)
- `CellLine_N61311_vs_N080611`: Comparison between cell lines
- `CellLine_N052611_vs_N080611`: Comparison between cell lines
- `Treatment_trt_vs_untrt`: **This is our main comparison of interest** (treated vs. untreated)

---

# Extract and Explore Results

## Extract Treatment Results

```{r extract-results}
# Extract results for Treatment effect
res <- results(dds, name = "Treatment_trt_vs_untrt")

# Summary of results
summary(res, alpha = 0.05)
```

## Structure of Results Table

```{r results-structure}
# Convert to data frame for easier manipulation
res_df <- as.data.frame(res)
res_df$EnsemblID <- rownames(res_df)

# Add gene symbols
res_df <- res_df %>%
  left_join(gene_annot[, c("EnsemblID", "GeneSymbol", "GeneName")], 
            by = "EnsemblID")

# Show structure
head(res_df)
```

**Column Descriptions:**
- **baseMean:** Mean normalized counts across all samples
- **log2FoldChange:** Log2 fold change (trt vs. untrt)
- **lfcSE:** Standard error of the log2 fold change
- **stat:** Wald test statistic
- **pvalue:** Raw p-value
- **padj:** Adjusted p-value (FDR/Benjamini-Hochberg)

## Top Differentially Expressed Genes

```{r top-genes}
# Order by adjusted p-value
res_df <- res_df[order(res_df$padj, na.last = TRUE), ]

# Top 10 upregulated genes
top_up <- res_df %>%
  filter(log2FoldChange > 0, !is.na(padj)) %>%
  head(10)

# Top 10 downregulated genes
top_down <- res_df %>%
  filter(log2FoldChange < 0, !is.na(padj)) %>%
  head(10)

# Display tables
cat("Top 10 Upregulated Genes:\n")
knitr::kable(top_up[, c("GeneSymbol", "GeneName", "baseMean", "log2FoldChange", "padj")], 
             digits = 3,
             caption = "Top 10 Upregulated Genes (padj < 0.05)")

cat("\nTop 10 Downregulated Genes:\n")
knitr::kable(top_down[, c("GeneSymbol", "GeneName", "baseMean", "log2FoldChange", "padj")], 
             digits = 3,
             caption = "Top 10 Downregulated Genes (padj < 0.05)")
```

---

# Multiple Testing Correction

## Why Multiple Testing Correction?

When testing thousands of genes simultaneously, we expect many false positives by chance alone. If we test 20,000 genes at α = 0.05, we'd expect ~1,000 false positives even if no genes are truly differentially expressed.

**The False Discovery Rate (FDR)** method (Benjamini-Hochberg) controls the expected proportion of false positives among all significant results.

## P-value Distributions

```{r pvalue-histograms}
# Histogram of raw p-values
p1 <- ggplot(res_df, aes(x = pvalue)) +
  geom_histogram(bins = 50, fill = "steelblue", color = "black") +
  theme_bw() +
  labs(title = "Distribution of Raw P-values",
       x = "P-value",
       y = "Frequency")

# Histogram of adjusted p-values
p2 <- ggplot(res_df, aes(x = padj)) +
  geom_histogram(bins = 50, fill = "coral", color = "black") +
  theme_bw() +
  labs(title = "Distribution of Adjusted P-values (FDR)",
       x = "Adjusted P-value",
       y = "Frequency")

# Combine plots
gridExtra::grid.arrange(p1, p2, ncol = 2)
```

**Interpretation:**
- **Raw p-values:** Should show enrichment of small p-values if there are true DE genes
- **Adjusted p-values:** More conservative, with many values near 1 (non-significant)

---

# Log Fold Change Shrinkage

## Why LFC Shrinkage?

For genes with low counts, fold change estimates can be unreliable and have high variance. **LFC shrinkage** uses information from all genes to provide more stable and accurate fold change estimates, especially for low-count genes.

The **apeglm** method is recommended for pairwise comparisons and provides good shrinkage behavior.

```{r lfc-shrinkage}
# Apply LFC shrinkage
res_shrink <- lfcShrink(dds, 
                        coef = "Treatment_trt_vs_untrt",
                        type = "apeglm")

# Convert to data frame
res_shrink_df <- as.data.frame(res_shrink)
res_shrink_df$EnsemblID <- rownames(res_shrink_df)

# Merge with original results
comparison_df <- res_df %>%
  select(EnsemblID, log2FoldChange) %>%
  rename(log2FoldChange_unshrunken = log2FoldChange) %>%
  left_join(res_shrink_df[, c("EnsemblID", "log2FoldChange")], 
            by = "EnsemblID") %>%
  rename(log2FoldChange_shrunken = log2FoldChange)
```

## Compare Shrunken vs. Unshrunken LFC

```{r lfc-comparison}
ggplot(comparison_df, aes(x = log2FoldChange_unshrunken, 
                          y = log2FoldChange_shrunken)) +
  geom_point(alpha = 0.3, color = "steelblue") +
  geom_abline(intercept = 0, slope = 1, color = "red", linetype = "dashed") +
  theme_bw() +
  labs(title = "LFC Shrinkage: Shrunken vs. Unshrunken",
       x = "Unshrunken log2FoldChange",
       y = "Shrunken log2FoldChange (apeglm)") +
  coord_fixed()
```

**Interpretation:** Shrunken LFC values are pulled toward zero, especially for genes with low counts or extreme fold changes. This reduces false positives from genes with unreliable estimates.

---

# Visualizations

## MA Plot (Mean vs. Log Fold Change)

MA plots show the relationship between average expression (baseMean) and log fold change.

```{r ma-plot-unshrunken}
# MA plot without shrinkage
DESeq2::plotMA(res, 
               ylim = c(-3, 3),
               main = "MA Plot: Unshrunken LFC")
```

```{r ma-plot-shrunken}
# MA plot with shrinkage
DESeq2::plotMA(res_shrink, 
               ylim = c(-3, 3),
               main = "MA Plot: Shrunken LFC (apeglm)")
```

**Interpretation:**
- Points above/below the horizontal line at y=0 are upregulated/downregulated
- Red points are significant (padj < 0.05)
- Shrunken LFC reduces extreme values for low-count genes

## Volcano Plot

```{r volcano-plot}
# Prepare data for volcano plot
volcano_df <- res_df %>%
  filter(!is.na(padj))

EnhancedVolcano(volcano_df,
                lab = volcano_df$GeneSymbol,
                x = 'log2FoldChange',
                y = 'padj',
                pCutoff = 0.05,
                FCcutoff = 1,
                pointSize = 2.0,
                labSize = 4.0,
                title = 'Volcano Plot: Dexamethasone Treatment',
                subtitle = 'Differential Expression Analysis',
                legendPosition = 'right',
                legendLabSize = 12,
                legendIconSize = 4.0,
                drawConnectors = TRUE,
                max.overlaps = 20)
```

## PCA Plot

Principal Component Analysis helps visualize sample relationships and check for batch effects.

```{r pca-plot}
# Transform counts using variance stabilizing transformation
vsd <- vst(dds, blind = FALSE)

# Calculate PCA
pca_data <- plotPCA(vsd, 
                    intgroup = c("Treatment", "CellLine"),
                    returnData = TRUE)

# Calculate percent variance
percentVar <- round(100 * attr(pca_data, "percentVar"))

# Plot PCA
ggplot(pca_data, aes(x = PC1, y = PC2, 
                     color = Treatment, 
                     shape = CellLine)) +
  geom_point(size = 4) +
  theme_bw() +
  labs(title = "PCA Plot: Treatment and Cell Line Effects",
       x = paste0("PC1: ", percentVar[1], "% variance"),
       y = paste0("PC2: ", percentVar[2], "% variance")) +
  scale_color_manual(values = c("untrt" = "steelblue", "trt" = "coral")) +
  coord_fixed()
```

**Interpretation:** Samples should cluster by Treatment along PC1, while CellLine effects may appear on other PCs. This confirms our design is working as expected.

## Heatmap of Top DE Genes

```{r heatmap}
# Select top 30 most significant genes
top_genes <- res_df %>%
  filter(!is.na(padj)) %>%
  arrange(padj) %>%
  head(30) %>%
  pull(EnsemblID)

# Extract VST-transformed counts
vsd_subset <- vsd[top_genes, ]

# Calculate z-scores for visualization
mat <- assay(vsd_subset)
mat <- mat - rowMeans(mat)
mat <- mat / apply(mat, 1, sd)

# Add gene symbols as row names
rownames(mat) <- res_df$GeneSymbol[match(rownames(mat), res_df$EnsemblID)]

# Create annotation
annotation_col <- data.frame(
  Treatment = colData(vsd_subset)$Treatment,
  CellLine = colData(vsd_subset)$CellLine,
  row.names = colnames(mat)
)

# Plot heatmap
pheatmap(mat,
         annotation_col = annotation_col,
         color = colorRampPalette(c("navy", "white", "firebrick"))(100),
         show_rownames = TRUE,
         show_colnames = FALSE,
         cluster_cols = TRUE,
         main = "Top 30 Most Significant DE Genes")
```

## Individual Gene Plots

Let's visualize the top 3 DE genes across treatments.

```{r gene-plots}
# Get top 3 genes
top3_genes <- res_df %>%
  filter(!is.na(padj)) %>%
  arrange(padj) %>%
  head(3)

# Function to plot individual gene
plot_gene <- function(ensembl_id, gene_symbol) {
  # Extract normalized counts
  plot_data <- data.frame(
    Count = counts(dds[ensembl_id, ], normalized = TRUE)[1, ],
    Treatment = colData(dds)$Treatment,
    CellLine = colData(dds)$CellLine,
    Sample = colnames(dds)
  )
  
  ggplot(plot_data, aes(x = Treatment, y = Count, fill = Treatment)) +
    geom_boxplot() +
    geom_point(aes(shape = CellLine), size = 3, position = position_jitter(width = 0.2)) +
    scale_y_log10() +
    theme_bw() +
    labs(title = paste0("Normalized Counts: ", gene_symbol),
         y = "Normalized Counts (log10 scale)") +
    scale_fill_manual(values = c("untrt" = "steelblue", "trt" = "coral")) +
    theme(legend.position = "right")
}

# Plot top 3 genes
for (i in 1:3) {
  print(plot_gene(top3_genes$EnsemblID[i], top3_genes$GeneSymbol[i]))
}
```

---

# Export Results

## Write Significant Genes to CSV

```{r export-results}
# Filter significant genes
sig_genes <- res_df %>%
  filter(padj < 0.05, !is.na(padj)) %>%
  arrange(padj)

# Add direction
sig_genes$Direction <- ifelse(sig_genes$log2FoldChange > 0, "Up", "Down")

# Select columns to export
export_cols <- c("EnsemblID", "GeneSymbol", "GeneName", 
                 "baseMean", "log2FoldChange", "lfcSE", 
                 "stat", "pvalue", "padj", "Direction")

# Write to CSV
write.csv(sig_genes[, export_cols], 
          file = "deseq2_wald_significant_genes.csv",
          row.names = FALSE)

cat("Exported", nrow(sig_genes), "significant genes to deseq2_wald_significant_genes.csv\n")
```

## Summary Statistics

```{r summary-stats}
summary_stats <- data.frame(
  Metric = c("Total genes tested",
             "Significant genes (padj < 0.05)",
             "Upregulated (padj < 0.05, LFC > 0)",
             "Downregulated (padj < 0.05, LFC < 0)"),
  Count = c(
    sum(!is.na(res_df$padj)),
    sum(res_df$padj < 0.05, na.rm = TRUE),
    sum(res_df$padj < 0.05 & res_df$log2FoldChange > 0, na.rm = TRUE),
    sum(res_df$padj < 0.05 & res_df$log2FoldChange < 0, na.rm = TRUE)
  )
)

knitr::kable(summary_stats, caption = "Summary Statistics")
```

---

# Biological Interpretation

## Overview of Results

Dexamethasone treatment in airway smooth muscle cells leads to significant changes in gene expression. The analysis identified `r sum(res_df$padj < 0.05, na.rm = TRUE)` significantly differentially expressed genes at an FDR of 5%.

**Key Findings:**
- **Upregulated genes:** `r sum(res_df$padj < 0.05 & res_df$log2FoldChange > 0, na.rm = TRUE)` genes show increased expression following dexamethasone treatment
- **Downregulated genes:** `r sum(res_df$padj < 0.05 & res_df$log2FoldChange < 0, na.rm = TRUE)` genes show decreased expression

## Example Gene Interpretation

```{r example-interpretation}
# Show top upregulated gene
top_up_gene <- top_up[1, ]
cat("Top Upregulated Gene:\n")
cat("Gene Symbol:", top_up_gene$GeneSymbol, "\n")
cat("Gene Name:", top_up_gene$GeneName, "\n")
cat("Log2 Fold Change:", round(top_up_gene$log2FoldChange, 2), "\n")
cat("Adjusted P-value:", format(top_up_gene$padj, scientific = TRUE, digits = 3), "\n")
cat("\nInterpretation: This gene shows a", 
    round(2^top_up_gene$log2FoldChange, 2), 
    "fold increase in expression following dexamethasone treatment.\n")
```

**Biological Context:** Dexamethasone is a glucocorticoid that acts through the glucocorticoid receptor to regulate gene expression. Expected changes include:
- Upregulation of anti-inflammatory genes
- Downregulation of pro-inflammatory genes
- Changes in genes involved in smooth muscle function

---

# Session Info

```{r session-info}
sessionInfo()
```

---

# References

Love, M. I., Huber, W., & Anders, S. (2014). Moderated estimation of fold change and dispersion for RNA-seq data with DESeq2. *Genome Biology*, 15(12), 550. https://doi.org/10.1186/s13059-014-0550-8

Zhu, A., Ibrahim, J. G., & Love, M. I. (2019). Heavy-tailed prior distributions for sequence count data: removing the noise and preserving large differences. *Bioinformatics*, 35(12), 2084-2092. https://doi.org/10.1093/bioinformatics/bty895

---

*End of Tutorial*
