"0","# Set factors with appropriate reference levels"
"0","metadata$Status <- factor(metadata$Status, levels = c(""virgin"", ""pregnant"", ""lactate""))"
"0","metadata$CellType <- factor(metadata$CellType, levels = c(""basal"", ""luminal""))"
"0","metadata$Group <- factor(metadata$Group)"
"0",""
"0","# Keep only samples that are in both count matrix and metadata"
"0","# Check if count matrix has column names"
"0","if (is.null(colnames(count_matrix))) {"
"0","  stop(""Count matrix has no column names. Please check the prepare-counts chunk."")"
"0","}"
"0",""
"0","# Try exact match first"
"0","common_samples <- intersect(colnames(count_matrix), metadata$Sample)"
"0",""
"0","cat(""Common samples found (exact match):"", length(common_samples), ""\n"")"
"1","Common samples found (exact match):"
"1"," "
"1","0"
"1"," "
"1","
"
"0","# If no exact matches, try matching by position (if same number)"
"0","if (length(common_samples) == 0 && ncol(count_matrix) == nrow(metadata)) {"
"0","  cat(""No exact matches, but same number of samples. Matching by position...\n"")"
"0","  cat(""WARNING: This assumes samples are in the same order in both files.\n"")"
"0","  common_samples <- colnames(count_matrix)"
"0","  # Update metadata Sample column to match count matrix column names"
"0","  metadata$Sample <- colnames(count_matrix)"
"0","  cat(""Matched"", length(common_samples), ""samples by position\n"")"
"0","}"
"1","No exact matches, but same number of samples. Matching by position...
"
"1","WARNING: This assumes samples are in the same order in both files.
"
"1","Matched"
"1"," "
"1","12"
"1"," "
"1","samples by position
"
"0","if (length(common_samples) == 0) {"
"0","  cat(""\nERROR: Cannot match samples.\n"")"
"0","  cat(""Count matrix column names:"", paste(colnames(count_matrix), collapse = "", ""), ""\n"")"
"0","  cat(""Metadata Sample column:"", paste(metadata$Sample, collapse = "", ""), ""\n"")"
"0","  cat(""\nPossible solutions:\n"")"
"0","  cat(""1. Check that sample names match exactly between files\n"")"
"0","  cat(""2. Rename samples in one file to match the other\n"")"
"0","  cat(""3. If samples are in the same order, the code will match by position\n"")"
"0","  stop(""No common samples found between count matrix and metadata. Please check sample names."")"
"0","}"
"0",""
"0","# Filter count matrix to only common samples (preserve column names)"
"0","count_matrix <- count_matrix[, common_samples, drop = FALSE]"
"0",""
"0","# Verify column names are preserved"
"0","if (is.null(colnames(count_matrix))) {"
"0","  cat(""Warning: Column names lost during filtering. Restoring.\n"")"
"0","  colnames(count_matrix) <- common_samples"
"0","}"
"0","cat(""Count matrix column names after filtering:"", paste(colnames(count_matrix), collapse = "", ""), ""\n"")"
"1","Count matrix column names after filtering:"
"1"," "
"1","MCL1.LA, MCL1.LB, MCL1.LC, MCL1.LD, MCL1.LE, MCL1.LF, MCL1.DG, MCL1.DH, MCL1.DI, MCL1.DJ, MCL1.DK, MCL1.DL"
"1"," "
"1","
"
"0","# Filter and reorder metadata to match count matrix column order"
"0","# Remove any NAs from match"
"0","metadata_match_idx <- match(common_samples, metadata$Sample)"
"0","if (any(is.na(metadata_match_idx))) {"
"0","  stop(""Some common samples not found in metadata. Please check data files."")"
"0","}"
"0","metadata <- metadata[metadata_match_idx, , drop = FALSE]"
"0","rownames(metadata) <- metadata$Sample"
"0",""
"0","# Verify alignment"
"0","cat(""Count matrix dimensions:"", dim(count_matrix), ""\n"")"
"1","Count matrix dimensions:"
"1"," "
"1","24094"
"1"," "
"1","12"
"1"," "
"1","
"
"0","cat(""Metadata dimensions:"", dim(metadata), ""\n"")"
"1","Metadata dimensions:"
"1"," "
"1","12"
"1"," "
"1","5"
"1"," "
"1","
"
"0","cat(""Sample names match:"", identical(colnames(count_matrix), rownames(metadata)), ""\n"")"
"1","Sample names match:"
"1"," "
"1","TRUE"
"1"," "
"1","
"
"0","# Verify"
"0","head(metadata)"
