"0","# Get significant genes"
"0","sig_genes_lrt <- res_status_df %>%"
"0","  filter(padj < 0.05, !is.na(padj)) %>%"
"0","  pull(EnsemblID)"
"0",""
"0","# Extract VST counts for significant genes"
"0","vsd_sig <- vsd[sig_genes_lrt, ]"
"0",""
"0","# Prepare data for degPatterns"
"0","# Need to create a data frame with gene, sample, and expression"
"0","# Note: degPatterns expects specific column names"
"0","pattern_data <- assay(vsd_sig) %>%"
"0","  as.data.frame() %>%"
"0","  tibble::rownames_to_column(""genes"") %>%"
"0","  tidyr::pivot_longer(cols = -genes, names_to = ""samplename"", values_to = ""value"") %>%"
"0","  left_join("
"0","    colData(vsd_sig) %>%"
"0","      as.data.frame() %>%"
"0","      tibble::rownames_to_column(""samplename"") %>%"
"0","      select(samplename, Status, CellType, Group),"
"0","    by = ""samplename"""
"0","  ) %>%"
"0","  mutate(Group = paste(CellType, Status, sep = ""_""))"
"0",""
"0","# Run degPatterns"
"0","# Note: This may take a few minutes"
"0","# Using a subset if there are too many genes for faster computation"
"0","if (length(sig_genes_lrt) > 1000) {"
"0","  # Use top 1000 genes for clustering"
"0","  top_genes_for_clustering <- res_status_df %>%"
"0","    filter(padj < 0.05, !is.na(padj)) %>%"
"0","    arrange(padj) %>%"
"0","    head(1000) %>%"
"0","    pull(EnsemblID)"
"0","  "
"0","  vsd_sig <- vsd[top_genes_for_clustering, ]"
"0","  pattern_data <- assay(vsd_sig) %>%"
"0","    as.data.frame() %>%"
"0","    tibble::rownames_to_column(""genes"") %>%"
"0","    tidyr::pivot_longer(cols = -genes, names_to = ""samplename"", values_to = ""value"") %>%"
"0","    left_join("
"0","      colData(vsd_sig) %>%"
"0","        as.data.frame() %>%"
"0","        tibble::rownames_to_column(""samplename"") %>%"
"0","        select(samplename, Status, CellType, Group),"
"0","      by = ""samplename"""
"0","    ) %>%"
"0","    mutate(Group = paste(CellType, Status, sep = ""_""))"
"0","}"
"0",""
"0","# Prepare metadata for degPatterns (one row per sample)"
"0","# IMPORTANT: metadata must have samplename as ROW NAMES, not as a column"
"0","metadata_patterns <- pattern_data %>%"
"0","  select(samplename, Status, CellType, Group) %>%"
"0","  distinct(samplename, .keep_all = TRUE) %>%"
"0","  as.data.frame()"
"0",""
"0","# Set samplename as row names"
"0","rownames(metadata_patterns) <- metadata_patterns$samplename"
"0","# Remove samplename column (it's now the row name)"
"0","metadata_patterns$samplename <- NULL"
"0",""
"0","# Verify data structure"
"0","cat(""Pattern data dimensions:"", dim(pattern_data), ""\n"")"
"1","Pattern data dimensions:"
"1"," "
"1","12000"
"1"," "
"1","6"
"1"," "
"1","
"
"0","cat(""Pattern data columns:"", paste(colnames(pattern_data), collapse = "", ""), ""\n"")"
"1","Pattern data columns:"
"1"," "
"1","genes, samplename, value, Status, CellType, Group"
"1"," "
"1","
"
"0","cat(""Metadata dimensions:"", dim(metadata_patterns), ""\n"")"
"1","Metadata dimensions:"
"1"," "
"1","12"
"1"," "
"1","3"
"1"," "
"1","
"
"0","cat(""Metadata row names:"", paste(rownames(metadata_patterns), collapse = "", ""), ""\n"")"
"1","Metadata row names:"
"1"," "
"1","MCL1.LA, MCL1.LB, MCL1.LC, MCL1.LD, MCL1.LE, MCL1.LF, MCL1.DG, MCL1.DH, MCL1.DI, MCL1.DJ, MCL1.DK, MCL1.DL"
"1"," "
"1","
"
"0","head(pattern_data)"
