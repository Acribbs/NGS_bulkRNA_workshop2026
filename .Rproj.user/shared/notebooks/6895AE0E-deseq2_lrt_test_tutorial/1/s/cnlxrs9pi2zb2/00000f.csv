"0","# Get significant genes"
"0","sig_genes_lrt <- res_status_df %>%"
"0","  filter(padj < 0.05, !is.na(padj)) %>%"
"0","  pull(EnsemblID)"
"0",""
"0","# Extract VST counts for significant genes"
"0","vsd_sig <- vsd[sig_genes_lrt, ]"
"0",""
"0","# Prepare data for degPatterns"
"0","# degPatterns expects a MATRIX with genes as rows and samples as columns"
"0","# NOT long format - it needs wide format"
"0",""
"0","# Run degPatterns"
"0","# Note: This may take a few minutes"
"0","# Using a subset if there are too many genes for faster computation"
"0","if (length(sig_genes_lrt) > 1000) {"
"0","  # Use top 1000 genes for clustering"
"0","  top_genes_for_clustering <- res_status_df %>%"
"0","    filter(padj < 0.05, !is.na(padj)) %>%"
"0","    arrange(padj) %>%"
"0","    head(1000) %>%"
"0","    pull(EnsemblID)"
"0","  "
"0","  vsd_sig <- vsd[top_genes_for_clustering, ]"
"0","}"
"0",""
"0","# Extract expression matrix (genes as rows, samples as columns)"
"0","expression_matrix <- assay(vsd_sig)"
"0",""
"0","# Prepare metadata for degPatterns (one row per sample)"
"0","# IMPORTANT: metadata must have samplename as ROW NAMES"
"0","metadata_patterns <- colData(vsd_sig) %>%"
"0","  as.data.frame() %>%"
"0","  tibble::rownames_to_column(""samplename"") %>%"
"0","  select(samplename, Status, CellType, Group) %>%"
"0","  distinct(samplename, .keep_all = TRUE) %>%"
"0","  as.data.frame()"
"0",""
"0","# Set samplename as row names"
"0","rownames(metadata_patterns) <- metadata_patterns$samplename"
"0","# Remove samplename column (it's now the row name)"
"0","metadata_patterns$samplename <- NULL"
"0",""
"0","# Verify data structure"
"0","cat(""Expression matrix dimensions:"", dim(expression_matrix), ""\n"")"
"1","Expression matrix dimensions:"
"1"," "
"1","1000"
"1"," "
"1","12"
"1"," "
"1","
"
"0","cat(""Expression matrix column names:"", paste(colnames(expression_matrix), collapse = "", ""), ""\n"")"
"1","Expression matrix column names:"
"1"," "
"1","MCL1.LA, MCL1.LB, MCL1.LC, MCL1.LD, MCL1.LE, MCL1.LF, MCL1.DG, MCL1.DH, MCL1.DI, MCL1.DJ, MCL1.DK, MCL1.DL"
"1"," "
"1","
"
"0","cat(""Metadata dimensions:"", dim(metadata_patterns), ""\n"")"
"1","Metadata dimensions:"
"1"," "
"1","12"
"1"," "
"1","3"
"1"," "
"1","
"
"0","cat(""Metadata row names:"", paste(rownames(metadata_patterns), collapse = "", ""), ""\n"")"
"1","Metadata row names:"
"1"," "
"1","MCL1.LA, MCL1.LB, MCL1.LC, MCL1.LD, MCL1.LE, MCL1.LF, MCL1.DG, MCL1.DH, MCL1.DI, MCL1.DJ, MCL1.DK, MCL1.DL"
"1"," "
"1","
"
"0","cat(""Column names match row names:"", identical(colnames(expression_matrix), rownames(metadata_patterns)), ""\n"")"
"1","Column names match row names:"
"1"," "
"1","TRUE"
"1"," "
"1","
"
"0","# Ensure column names of matrix match row names of metadata"
"0","if (!identical(colnames(expression_matrix), rownames(metadata_patterns))) {"
"0","  # Reorder metadata to match matrix columns"
"0","  metadata_patterns <- metadata_patterns[colnames(expression_matrix), , drop = FALSE]"
"0","  cat(""Reordered metadata to match matrix columns\n"")"
"0","}"
"0",""
"0","# Run degPatterns"
"0","# Note: degPatterns expects:"
"0","# - A matrix with genes as rows and samples as columns"
"0","# - metadata: data frame with one row per sample, with samplename as ROW NAMES"
"0","patterns <- degPatterns(expression_matrix, "
"0","                        metadata = metadata_patterns,"
"0","                        time = ""Status"","
"0","                        col = ""CellType"","
"0","                        minc = 5,"
"0","                        reduce = TRUE,"
"0","                        plot = TRUE)"
