"0","# Quick PCA on raw counts to check for batch effects"
"0","# Use log-transformed counts for PCA"
"0","log_counts <- log2(count_matrix + 1)"
"0",""
"0","# Filter out genes with zero variance (needed for scaling)"
"0","gene_vars <- apply(log_counts, 1, var)"
"0","keep_genes_pca <- gene_vars > 0"
"0","log_counts_filtered <- log_counts[keep_genes_pca, ]"
"0",""
"0","cat(""Genes with zero variance removed:"", sum(!keep_genes_pca), ""\n"")"
"1","Genes with zero variance removed:"
"1"," "
"1","4627"
"1"," "
"1","
"
"0","cat(""Genes used for PCA:"", sum(keep_genes_pca), ""\n"")"
"1","Genes used for PCA:"
"1"," "
"1","19467"
"1"," "
"1","
"
"0","pca_raw <- prcomp(t(log_counts_filtered), scale. = TRUE)"
"0",""
"0","pca_df_raw <- data.frame("
"0","  PC1 = pca_raw$x[, 1],"
"0","  PC2 = pca_raw$x[, 2],"
"0","  CellType = metadata$CellType,"
"0","  Status = metadata$Status,"
"0","  Group = metadata$Group"
"0",")"
"0",""
"0","percentVar_raw <- round(100 * summary(pca_raw)$importance[2, 1:2])"
"0",""
"0","ggplot(pca_df_raw, aes(x = PC1, y = PC2, color = Status, shape = CellType)) +"
"0","  geom_point(size = 4) +"
"0","  theme_bw() +"
"0","  labs(title = ""PCA Plot: Raw Counts (Quality Control)"","
"0","       x = paste0(""PC1: "", percentVar_raw[1], ""% variance""),"
"0","       y = paste0(""PC2: "", percentVar_raw[2], ""% variance"")) +"
"0","  scale_color_manual(values = c(""virgin"" = ""steelblue"", "
"0","                                 ""pregnant"" = ""orange"", "
"0","                                 ""lactate"" = ""firebrick"")) +"
"0","  coord_fixed()"
